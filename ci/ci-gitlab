set -ex

. /home/user/env/bin/activate
pip install . plugins/gitlab

#setup
ROOT="$HOME/wildland"

# Create and mount two GitLab containers: with and without specified project ID
./wl user create gitlab-user
./wl container create GitLab-p --path /gitlab
./wl storage create gitlab --container GitLab-p --personal-token $PERSONAL_GITLAB_TOKEN --projectid 27483617
./wl start
./wl container mount --with-subcontainers GitLab-p

# List full tree
time -p chronic tree $ROOT

# List /wildland directory
time -p chronic ls $ROOT

# List contents of the project directory
time -p chronic ls $ROOT/projects/ci\ example\ project/

# List contents of the timeline directory for the project
time -p test -d $ROOT/timeline/2021/06/16

# Checking the categories permutation
time -p test -d $ROOT/projects/ci\ example\ project/@labels/feature/

#labels with 2 issues
time -p test -f $ROOT/labels/backends/issue\ 1/issue\ 1.md
time -p test -f $ROOT/labels/backends/issue\ 2/issue\ 2.md

#labes with a single issue
time -p test -f $ROOT/labels/feature/issue\ 1/issue\ 1.md
time -p test -f $ROOT/labels/welcome/issue\ 2/issue\ 2.md

# Read contents of files
time -p chronic grep 'issue' $ROOT/projects/ci\ example\ project/issue\ 2/issue\ 2.md

# Unmount the container
time -p chronic ./wl container unmount GitLab-p

./wl container create GitLab --path /gitlab
./wl storage create gitlab --container GitLab --personal-token $PERSONAL_GITLAB_TOKEN

# Mount a GitLab container (without specified project ID)
./wl container mount --with-subcontainers GitLab

# List contents of the timeline directory for the project
time -p test -d $ROOT/timeline/2021/06/16

#labes with a single issue
time -p test -f $ROOT/labels/feature/issue\ 1/issue\ 1.md
time -p test -f $ROOT/labels/welcome/issue\ 2/issue\ 2.md

# Unmount the container
time -p chronic ./wl container unmount GitLab
