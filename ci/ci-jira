set -ex

. /home/user/env/bin/activate
pip install . plugins/jira

#setup
ROOT="$HOME/wildland"
MNT_DIR_1="jira-mnt-1"
MNT_DIR_2="jira-mnt-2"
WORKSPACE_API_URL='https://wookhash.atlassian.net/rest/api/2'
PROJECT_NAME='Jira Test'

# Create and mount two Jira containers: with and without specified project
wl user create jira-user
wl container create jira-p --path "/$MNT_DIR_1"
wl storage create jira --container jira-p --workspace-url $WORKSPACE_API_URL --username $JIRA_USERNAME --personal-token $PERSONAL_JIRA_TOKEN --project-name "$PROJECT_NAME"
wl start
wl container mount --with-subcontainers jira-p

# List full tree
time -p chronic tree "$ROOT"

# List /wildland directory
time -p chronic ls "$ROOT"

# List contents of the project directory
time -p chronic ls "$ROOT"/projects/"$PROJECT_NAME"

# Checking the categories permutation
time -p test -d "$ROOT"/projects/"$PROJECT_NAME"/Aegypius\ occipitalis/Aegypius\ occipitalis.md
time -p test -d "$ROOT"/projects/"$PROJECT_NAME"/@labels/Documentacao/Aegypius\ occipitalis/Aegypius\ occipitalis.md
time -p test -d "$ROOT"/labels/Documentacao/@projects/"$PROJECT_NAME"/Aegypius\ occipitalis/Aegypius\ occipitalis.md
time -p test -d "$ROOT"/projects/"$PROJECT_NAME"/@statuses/To\ Do/Aegypius\ occipitalis/Aegypius\ occipitalis.md
time -p test -d "$ROOT"/statuses/To\ Do/@projects/"$PROJECT_NAME"/Aegypius\ occipitalis/Aegypius\ occipitalis.md

# Read contents of files
time -p chronic grep 'primis in faucibus' $ROOT/projects/"$PROJECT_NAME"/Aegypius\ occipitalis/Aegypius\ occipitalis.md

# Unmount the container
time -p chronic wl container unmount jira-p

wl container create jira-a --path "/$MNT_DIR_2"
wl storage create jira --container jira-a --workspace-url $WORKSPACE_API_URL --username $JIRA_USERNAME --personal-token $PERSONAL_JIRA_TOKEN

# Mount a Jira container (without specified project ID)
wl container mount --with-subcontainers jira-a

time -p test -f "$ROOT"/labels/welcome/@statuses/To\ Do/Phaethon\ aethereus/Phaethon\ aethereus.md

# Unmount the container
time -p chronic wl container unmount jira-a

# Test storage template creation
wl template create jira --workspace-url $WORKSPACE_API_URL --username $JIRA_USERNAME --personal-token $PERSONAL_JIRA_TOKEN --limit 10 myjira

wl container create jira-template --template myjira
wl container mount jira-template

# Verify that the template creation is working
time -p chronic tree $ROOT

wl container unmount jira-template
